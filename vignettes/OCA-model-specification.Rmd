---
title: "OCA1 model specification"
author: "P.J. Dodd, M. Dunning, N. Mafirakureva, D.A. Shaweno"
# output: rmarkdown::html_vignette
output:
  pdf_document:
    toc: true
    number_sections: true
header-includes:
  \usepackage{fourier}
vignette: >
  %\VignetteIndexEntry{OCA-model-specification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Purpose

This R package supplies a tuberculosis (TB) transmission model that represents UK population dynamics and is intended to be flexible in what structural aspects it represents for particular problems. The aim is to provide an analytical tool to evaluate the economic and epidemiological impact of policy options. 

# Structure

The overall strcture is represented in Figure 1. The TB layers follow a fairly standard pattern:

- Uninfected: those with not evidence of TB infection
- Latent fast: those with evidence of recent TB infection at higher risk of progression to TB disease
- Latent slow: those with evidence of older TB infection at lower risk of progression to TB disease
- Asymptomatic TB disease: those with TB disease who are not aware of symptoms
- Symptomatic TB disease: those with TB disease who are aware of symptoms
- TB treatment: those receiving anti-TB treatment

![Model diagram.](model.png)

## Layers

Other aspects of structure are represented as layers, most of which have have numbers which can be specified by users. Technically, layers represent index values in multidimensional arrays. 
The following 7 aspects of structure are represented as layers:

- Age (fixed): there are 17 5-year age groups, 0-4 years up to 80+ years 
- Sex (fixed): there are two genders (male, female)
- Natal class (variable): this is to represent population sectors arriving from higher TB risk countries
- Risk group (variable): this is to population sectors with social risk factors, or HIV/ART etc. 
- Post-TB (variable): this is to represent people who have previously had TB
- Strain (variable): this is for explicit representation of drug-resistant strains
- Protection (variable): this is to represent interventions like preventive therapy

# Installation and use

The model is maintained on GitHub at: [https://github.com/petedodd/OCA1](https://github.com/petedodd/OCA1). 


## Installation

Installing the package requires R to be setup to compile C code. If the R package `devtools` has been installed, `OCA1` can be installed by running:


```{r, eval=FALSE}
devtools::install_github("petedodd/OCA1")
```

If the argument `build_vignettes=TRUE` is added to the above, this document will be generated and can be found via 

```{r,eval=FALSE}
browseVignettes(package = "OCA1")
```
If it is not possible to compile C code on your system, you may ask a user of the same operating system to generate you a binary version of the package.

## Creating model parameters

Having installed the package, it can be loaded in the usual way and the `known_parameters()` function gives a read out with the parameters available for specification associated with each element of the structure:
```{r setup}
library(OCA1) #load the package

##what parameters are available [with what dimensions]
known_parameters()
```
In addition many of the functions have their own R man pages guiding use, although some are still in draft.

We have tried to minimize the load required by a user to specify parameters through a system of defaults:
```{r}
## example without nativity class used
pms <- create_parms(verbose=TRUE) #create UK parameters
```
By default, there is only one layer for each of the variable structure elements. The more layers there are, the more ordinary differential equations (ODEs) the model uses, and therefore the slower it is.

Going beyond defaults means specifying the number of layers for each aspect of structure, and providing parameter data associated with this structure within a separate list. The input lists are:

- `migrationdata`: parameters to define migration dynamics
- `riskdata`: parameters to define risk structure and dynamics 
- `postdata`: parameters to define post-TB structure and dynamics
- `straindata`: parameters to define aspects of strain structure
- `protdata`: paraneters to define protection structure and dynamics
- `tbparms`: these are TB-specific parameters, not necessarily associated with layer dimensions

where lists, or items within lists, are not provided, appropriate dimension defaul values will be provided.


For example, to speciy 2 natal classes with 90% of people initially in the native-born layer, one would use:
```{r}
# version with 2 static nativity classes
pms <- create_parms(nnat = 2, migrationdata = list(propinitnat = c(0.9,0.1)))
```


To have two layers in the natal class and risk dimensions, one would use:
```{r}
## version with 2 static nativity classes and 2 static risk classes
pms <- create_parms(nnat = 2, nrisk = 2,
                    migrationdata = list(propinitnat = c(0.9,0.1)),
                    riskdata = list(propinitrisk = c(0.9,0.1)))
```

If `verbose=TRUE`, the number of strata is stated. Having 2 layers in every dimension means having thousands of ODEs. 
```{r}
## go big version with all strata to some degree:
pms <- create_parms(
  nnat = 2, nrisk = 2, npost = 2, nstrain = 2, nprot = 2,
  migrationdata = list(propinitnat = c(0.9,0.1)),
  riskdata = list(propinitrisk = c(0.9,0.1)),
  straindata = list(propinitstrain = c(0.9,0.1)),
  protdata = list(propinitprot = c(0.9,0.1)))
```
It is not really intended that all layers should be used at once, and doing so may easily result in a model that is not possible to run, or not possible to run fast enough to be practically useful.

The years run over are set via the `tc` argument to `create_parms` which is `tc=1970:2020` by default. Some input parameters (e.g. migration rates, case detection rates) are arrays with a time dimension to capture their dynamics. These variables are automatically linearly interpolated within the model based on input data. 

As far as possible, we have tried to design checks for parameters provided to ensure that they make sense for the intended model structure.

## Running the model

For a given set of parameters, `runmodel` will run the model. By default, the output will be split into a list of `data.table` objects which represent model output in 'long' format

```{r}
## example without nativity class used
pms <- create_parms(tbparms=list(staticfoi=1, foi=1e-2)) #create UK parameters

out <- runmodel(pms)              #run model with these
out                               #inspect
```


## Visualizing model output

We have provided a few plotting utilities for inspecting model output.

In the case of demography, these compare model output (lines) against UK data (points) for total population :
```{r}
## visualize
plt_DemoGrowth(out)               #total population over time
```

and also for age/sex strata:
```{r,fig.dim = c(8, 6)}
plt_DemoSnapshots(out)            #snapshots
```

There are analogous plotters for some TB aspects, which can specify splits by certain layers:
```{r}
plt_TBSnapshots(out, by_layer = "natcat")
```

Similarly for the different rates outputted by the model:
```{r}

plt_TBRates(out,rate_type = "incidence",by_layer = "natcat")
```

# Example use

TODO


# Mathematical specification


$$
\frac{\mathrm{d}}{\mathrm{d}t}N_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)
$$

where $a$ is age, $s$ is sez, $n$ is natal class, $r$ is risk group, $p$ is protection, and $q$ is strain.

$$
\begin{aligned}
& \frac{\mathrm{d}}{\mathrm{d}t}U_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)\\
& \frac{\mathrm{d}}{\mathrm{d}t}E_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)\\
& \frac{\mathrm{d}}{\mathrm{d}t}L_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)\\
& \frac{\mathrm{d}}{\mathrm{d}t}A_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)\\
& \frac{\mathrm{d}}{\mathrm{d}t}D_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)\\
& \frac{\mathrm{d}}{\mathrm{d}t}T_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)
\end{aligned}
$$

TODO other stuff


$$
\begin{aligned}
    & \frac{\mathrm{d}}{\mathrm{d}t}N_{a,s,n,r,p,q}(t) = {b}_{a,s,n,r,p,q}(t) - \bar{\mu}N_{a,s,n,r,p,q}(t)\\
    & N_t(s,a,h,r) = \overbrace{b_t(s)\delta(a)}^{\mathrm{births}} -\overbrace{ \mu^0_t(s,a)N_t(s,a,h,r)}^{\mathrm{background~deaths}} + \overbrace{m_t(s,a)}^{\mathrm{net~migration}}\\
    & -\chi_{h>0}\chi_{r=0}\times\mu^H(s,a,h)N_t(s,a,h,r)\\
    &-\chi_{h>0}\chi_{r>0}\times\mu^A(s,a,h,r)N_t(s,a,h,r)  \\
    & -H(t)\pi^H_t(s,a,h)\left[\chi_{h=r=0} - \chi_{h>0}\right]\\
    & -A(t)\pi^A_t(s,a,h)\left[\chi_{r'=0} - \chi_{r'=1}\right]\\
    & -\chi_{r=0}\left[\chi_{h>0}R^H(s,a,h)N_t(s,a,h,r) - \chi_{h>1}R^H(s,a,h-1)N_t(s,a,h-1,r)\right]\\
    & -\chi_{r>0}\left[R^A(r)N_t(s,a,h,r) -R^A(r-1)N_t(s,a,h,r-1)\right]\label{eqn:artprogn}
\end{aligned}
$$



## yet more

aaa

$$
\begin{aligned}
    & \left(\frac{\partial}{\partial t}+\frac{\partial}{\partial a}\right) N_t(s,a,h,r) = \overbrace{b_t(s)\delta(a)}^{\mathrm{births}} -\overbrace{ \mu^0_t(s,a)N_t(s,a,h,r)}^{\mathrm{background~deaths}} + \overbrace{m_t(s,a)}^{\mathrm{net~migration}}\\
    & -\chi_{h>0}\chi_{r=0}\times\mu^H(s,a,h)N_t(s,a,h,r)\\
    &-\chi_{h>0}\chi_{r>0}\times\mu^A(s,a,h,r)N_t(s,a,h,r)  \\
    & -H(t)\pi^H_t(s,a,h)\left[\chi_{h=r=0} - \chi_{h>0}\right]\\
    & -A(t)\pi^A_t(s,a,h)\left[\chi_{r'=0} - \chi_{r'=1}\right]\\
    & -\chi_{r=0}\left[\chi_{h>0}R^H(s,a,h)N_t(s,a,h,r) - \chi_{h>1}R^H(s,a,h-1)N_t(s,a,h-1,r)\right]\\
    & -\chi_{r>0}\left[R^A(r)N_t(s,a,h,r) -R^A(r-1)N_t(s,a,h,r-1)\right]\label{eqn:artprogn}
\end{aligned}
$$

And also

$$
\frac{\mathrm{d}}{\mathrm{d}t}X_t(s,a) = {b}_t(s) - \bar{\mu}^0_t(s,a)X_t(s,a)
$$

## Example of implementing in-migration and out-migration 

First let's generate  dummy migration data. Assuming that both in-migration and out-migration follow a polynomial distribution as  function of year :

$$
Y(t) = \beta_0 + \beta_1 t + \beta_2 t^2 
$$

Plugging the following  $\beta$ coefficients into the above equation, we can generate in-migration and outmigration dummy data as in below: 

### Overall migration

```{r}
pms <- create_parms(nnat = 2, 
                    migrationdata = list(propinitnat = c(0.9,0.1)))
Year   <-1970:2020
inmigr <- 5.114998e+05 - 5.238264e+02*Year +  1.341414e-01*Year^2
emigr  <- 3.127034e+05 - 3.170702e+02*Year +  8.043165e-02*Year^2

exmigrans <-data.frame(British= 0.35, foreign=0.65)
prop_males <- c(rep(c(1,2,3.5,5.5,5,3,2,1), each=2),1)/100
prop_females <-c(rep(c(1,2,4,6,5,3.5,2.5,1.5), each=2),2)/100

imig <- array(0, dim= dim(pms[["immigration"]]), 
              dimnames =dimnames(pms[["immigration"]]))
emig <- array(0, dim= dim(pms[["exmigrate"]]), 
               dimnames =dimnames(pms[["exmigrate"]]))

for (year in 1:51) {
  imig[year, , 1] <- inmigr[year] * prop_males  
  imig[year, , 2] <- inmigr[year] * prop_females  
}

prop_uk_born= 0.35 # assuming 35% of emigranst are UK born

# propagate by nationality
for (year in 1:51) {
  emig[year, , ,1] <- emigr[year] * prop_uk_born  
  emig[year, , ,2] <- emigr[year] * (1-prop_uk_born)  
}

# propagate into age and sex
for (year in 1:51) {
  emig[year, , 1, ] <- emig[year, , 1, ] * prop_males  # Males
  emig[year, , 2, ] <- emig[year, , 2, ] * prop_females  # Females
}

```

We can now call the parameter generating function and update the migration inputs as below:

```{r}
pms <- create_parms(nnat = 2, 
                    migrationdata = list(propinitnat = c(0.9,0.1)))


pms$immigration <- imig
pms$exmigrate <- emig

out <- runmodel(pms)
plt_DemoGrowth(out)  

```

### Country specific migration

If a particular country say India contributes 10% of immigrants, the model can be run for that scenario as follows:

```{r}
pms$immigration <- imig*0.1
out <- runmodel(pms)
plt_DemoGrowth(out)  
```




